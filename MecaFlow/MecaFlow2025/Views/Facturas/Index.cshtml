@model IEnumerable<MecaFlow2025.Models.Factura>
@using System.Globalization
@{
    ViewData["Title"] = "Facturas";
    var cr = new CultureInfo("es-CR");
}

<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet">

<style>
    body {
        background: linear-gradient(135deg, #0f2027, #203a43, #2c5364);
        color: #f8f9fa;
        animation: gradient 15s ease infinite;
        background-size: 400% 400%;
    }

    @@keyframes gradient { 0%{background-position:0% 50%} 50%{background-position:100% 50%} 100%{background-position:0% 50%} }
    @@keyframes fadeInUp { from{opacity:0;transform:translateY(20px)} to{opacity:1;transform:translateY(0)} }
    @@keyframes fadeIn { from{opacity:0;transform:scale(.95)} to{opacity:1;transform:scale(1)} }
    @@keyframes pulse { 0%{transform:scale(1);box-shadow:0 0 0 0 rgba(13,110,253,.4)} 70%{transform:scale(1.05);box-shadow:0 0 0 10px rgba(13,110,253,0)} 100%{transform:scale(1);box-shadow:0 0 0 0 rgba(13,110,253,0)} }

    .invoice-card{
        background-color:#1f1f1f;border:1px solid #2c2c2c;color:#fff;border-radius:1rem;
        transition:transform .3s ease, box-shadow .3s ease;margin-bottom:1rem;position:relative;
        animation:fadeInUp .5s ease-in-out;
    }
    .invoice-card:hover{ transform:translateY(-5px);box-shadow:0 8px 20px rgba(0,0,0,.3); }

    .invoice-grid{ display:grid;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:1rem; }

    .form-control:focus{ background-color:#2c2c2c;color:#fff;border-color:#66afe9;box-shadow:0 0 0 .2rem rgba(102,175,233,.25); }

    .action-icons{
        position:absolute;top:.75rem;right:1rem;display:flex;gap:.75rem;z-index:2;
    }
    .action-icons a,.action-icons button{
        background:none;border:none;padding:0;font-size:1.25rem;color:inherit;transition:transform .2s ease;
    }
    .action-icons a:hover,.action-icons button:hover{ transform:scale(1.2); }

    /* --- FIX superposición: dejamos aire arriba y reservamos espacio a la derecha --- */
    .invoice-card .card-body{ padding-top:2.2rem; }
    .invoice-card .header-safe{ padding-right:72px; } /* espacio para 3 íconos */
    @@media (max-width:420px){ .invoice-card .header-safe{ padding-right:56px; } }

    .modal-content{ background-color:#1f1f1f;color:#fff;animation:fadeIn .3s ease-in-out; }
    .btn-pulse{ animation:pulse 2s infinite; }

    .badge-soft{ background-color:#2a2a2a;border:1px solid #3a3a3a;color:#cfe8ff;padding:.2rem .5rem;border-radius:.5rem;font-size:.8rem; }
</style>

<div class="container py-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2 class="text-white">
            <i class="bi bi-receipt me-2"></i>Facturas
        </h2>
        <div class="d-flex align-items-center">
            <input id="invoiceSearch" type="search" class="form-control form-control-sm me-3 bg-dark text-white border-secondary"
                   placeholder="Buscar por cliente, placa, método…">
            <a href="#" class="btn btn-primary btn-pulse" onclick="loadCreateForm()">
                <i class="bi bi-plus-circle me-1"></i>Nueva Factura
            </a>
        </div>
    </div>

    @if (TempData["Ok"] is string ok && !string.IsNullOrWhiteSpace(ok))
    {
        <div class="d-none" id="tempOk" data-msg="@ok"></div>
    }
    @if (TempData["Error"] is string err && !string.IsNullOrWhiteSpace(err))
    {
        <div class="d-none" id="tempErr" data-msg="@err"></div>
    }

    <div id="invoicesGrid" class="invoice-grid">
        @foreach (var f in Model)
        {
            <div class="invoice-card card" id="factura-@f.FacturaId">
                <div class="action-icons">
                    <a href="#" class="text-info" title="Detalles" data-bs-toggle="modal" data-bs-target="#modalDetails-@f.FacturaId">
                        <i class="bi bi-eye"></i>
                    </a>
                    <a href="#" class="text-warning" title="Editar" onclick="loadEditForm(@f.FacturaId)">
                        <i class="bi bi-pencil-square"></i>
                    </a>
                    <button type="button" class="text-danger" title="Eliminar" onclick="confirmDelete(@f.FacturaId)">
                        <i class="bi bi-trash-fill"></i>
                    </button>
                </div>

                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-start header-safe">
                        <h5 class="card-title mb-1">Factura #@f.FacturaId</h5>
                        <span class="badge badge-soft">@f.Fecha.ToString("dd/MM/yyyy")</span>
                    </div>
                    <p class="card-text mb-1">
                        <i class="bi bi-person-fill me-1"></i>@(f.Cliente?.Nombre ?? "—")
                    </p>
                    <p class="card-text mb-1">
                        <i class="bi bi-car-front-fill me-1"></i>@(f.Vehiculo?.Placa ?? "—")
                    </p>
                    <p class="card-text mb-1">
                        <i class="bi bi-credit-card-2-front-fill me-1"></i>@(string.IsNullOrWhiteSpace(f.Metodo) ? "—" : f.Metodo)
                    </p>
                    <p class="card-text fw-semibold">
                        <i class="bi bi-cash-stack me-1"></i>@f.MontoTotal.ToString("C", cr)
                    </p>
                </div>
            </div>

            <!-- Modal Details -->
            <div class="modal fade" id="modalDetails-@f.FacturaId" tabindex="-1" aria-labelledby="modalDetailsLabel-@f.FacturaId" aria-hidden="true">
                <div class="modal-dialog modal-dialog-centered">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title" id="modalDetailsLabel-@f.FacturaId">Detalles de la Factura #@f.FacturaId</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
                        </div>
                        <div class="modal-body">
                            <p><strong>Fecha:</strong> @f.Fecha.ToString("dd/MM/yyyy")</p>
                            <p><strong>Cliente:</strong> @(f.Cliente?.Nombre ?? "—")</p>
                            <p><strong>Vehículo:</strong> @(f.Vehiculo?.Placa ?? "—")</p>
                            <p><strong>Método de pago:</strong> @(string.IsNullOrWhiteSpace(f.Metodo) ? "—" : f.Metodo)</p>
                            <p class="mb-0"><strong>Monto total:</strong> @f.MontoTotal.ToString("C", cr)</p>
                        </div>
                    </div>
                </div>
            </div>
        }
    </div>
</div>

<!-- Toasts -->
<div class="toast align-items-center text-bg-success border-0 position-fixed bottom-0 end-0 m-3" id="toastSuccess" role="alert" aria-live="assertive" aria-atomic="true">
    <div class="d-flex">
        <div class="toast-body">¡Acción realizada con éxito!</div>
        <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
    </div>
</div>
<div class="toast align-items-center text-bg-danger border-0 position-fixed bottom-0 end-0 m-3" id="toastError" role="alert" aria-live="assertive" aria-atomic="true">
    <div class="d-flex">
        <div class="toast-body">Ups… algo salió mal.</div>
        <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
    </div>
</div>

<!-- Modal Delete -->
<div class="modal fade" id="deleteModal" tabindex="-1" aria-labelledby="deleteModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="deleteModalLabel">Confirmar eliminación</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
            </div>
            <div class="modal-body">
                <p>¿Seguro que deseas eliminar esta factura?</p>
            </div>
            <div class="modal-footer">
                <form id="deleteForm" method="post">
                    <input type="hidden" name="id" id="deleteFacturaId" />
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="submit" class="btn btn-danger">Eliminar</button>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Modal Edit -->
<div class="modal fade" id="editModal" tabindex="-1" aria-labelledby="editModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="editModalLabel">Editar Factura</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
            </div>
            <div class="modal-body" id="editModalBody">
                <p class="text-center">Cargando…</p>
            </div>
        </div>
    </div>
</div>

<!-- Modal Create -->
<div class="modal fade" id="createModal" tabindex="-1" aria-labelledby="createModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="createModalLabel">Nueva Factura</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
            </div>
            <div class="modal-body" id="createModalBody">
                <p class="text-center">Cargando…</p>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        // Buscador en vivo
        document.getElementById('invoiceSearch').addEventListener('input', function () {
            var q = this.value.toLowerCase();
            document.querySelectorAll('#invoicesGrid .card').forEach(function (card) {
                const txt = Array.from(card.querySelectorAll('.card-title, .card-text'))
                    .map(e => e.innerText.toLowerCase()).join(' ');
                card.style.display = txt.includes(q) ? '' : 'none';
            });
        });

        // Toasts desde TempData
        (function () {
            const ok = document.getElementById('tempOk');
            const err = document.getElementById('tempErr');
            if (ok) {
                document.querySelector('#toastSuccess .toast-body').innerText = ok.dataset.msg || '¡Acción realizada con éxito!';
                new bootstrap.Toast(document.getElementById('toastSuccess')).show();
            }
            if (err) {
                document.querySelector('#toastError .toast-body').innerText = err.dataset.msg || 'Ups… algo salió mal.';
                new bootstrap.Toast(document.getElementById('toastError')).show();
            }
        })();

        // Edit en modal (AJAX)
        function loadEditForm(facturaId) {
            const modalBody = document.getElementById('editModalBody');
            modalBody.innerHTML = "<p class='text-center'>Cargando formulario...</p>";
            const modal = new bootstrap.Modal(document.getElementById('editModal'));
            modal.show();

            fetch(`/Facturas/Edit/${facturaId}`, { headers: { 'X-Requested-With': 'XMLHttpRequest' } })
                .then(r => r.text())
                .then(html => modalBody.innerHTML = html)
                .catch(() => modalBody.innerHTML = `<div class="alert alert-danger">Error al cargar el formulario</div>`);
        }

        // Create en modal (AJAX)
        function loadCreateForm() {
            const modalBody = document.getElementById('createModalBody');
            modalBody.innerHTML = "<p class='text-center'>Cargando formulario...</p>";
            const modal = new bootstrap.Modal(document.getElementById('createModal'));
            modal.show();

            fetch(`/Facturas/Create`, { headers: { 'X-Requested-With': 'XMLHttpRequest' } })
                .then(r => r.text())
                .then(html => modalBody.innerHTML = html)
                .catch(() => modalBody.innerHTML = `<div class="alert alert-danger">Error al cargar el formulario</div>`);
        }

        // Confirmación de delete
        function confirmDelete(facturaId) {
            const modal = new bootstrap.Modal(document.getElementById('deleteModal'));
            document.getElementById('deleteFacturaId').value = facturaId;
            document.getElementById('deleteForm').action = `/Facturas/Delete/${facturaId}`;
            modal.show();
        }
    </script>
}
